# ミカモポータル DXナレッジベース運用ガイド

## 概要

ミカモポータルのナレッジベースは、株式会社みかもの4つの事業部門（Soup、Mnet、みかも喫茶、みかも石油）に関する情報を蓄積し、スタッフQA AIが参照するための知識基盤です。

## DXレポートの登録

### 初期データとしてのDXレポート

システム初期セットアップ時に、Claude AIによる包括的なDXリサーチレポートをナレッジベースに登録できます。このレポートは6つのセクションに分割されて登録されます。

1. **エグゼクティブサマリー＆序論** - 全社共通
2. **カーコーティング Soup 分析** - Soup事業部
3. **Mnet 中古車販売 分析** - Mnet事業部
4. **みかも喫茶 分析** - 喫茶事業部
5. **みかも石油 分析** - 石油事業部
6. **統合DX戦略＆結論** - 全社共通

### シードスクリプトの実行

```bash
# バックエンドディレクトリに移動
cd backend

# DXレポートを登録
python scripts/seed_dx_knowledge.py
```

スクリプトは以下の処理を行います：
- 既存のDXレポートナレッジ（category="DXレポート"）を削除
- 6つのセクションを新規登録
- 各セクションを適切な事業部門に紐付け

## ナレッジモデルの構造

### KnowledgeItem フィールド

| フィールド | 型 | 説明 |
|---|---|---|
| id | int | 主キー |
| tenant_id | int | テナントID（マルチテナント対応） |
| business_unit_id | int | 事業部門ID（NULL=全社共通） |
| title | str | タイトル |
| content | str | 本文（Markdown対応） |
| category | str | カテゴリ（例：DXレポート、レシピ、マニュアル） |
| source | str | 情報元（例：Claude AI調査レポート） |
| tags | List[str] | タグ（文字列配列） |
| created_by | int | 作成者ユーザーID |
| updated_by | int | 更新者ユーザーID |
| created_at | datetime | 作成日時 |
| updated_at | datetime | 更新日時 |

### カテゴリの例

- `DXレポート` - AI調査レポート
- `レシピ` - みかも喫茶のメニューレシピ
- `マニュアル` - 業務マニュアル・手順書
- `お知らせ` - 社内お知らせ・通達
- `FAQ` - よくある質問と回答

### ソースの例

- `Claude AI調査レポート (2025年)` - AI生成レポート
- `社内資料` - 既存の社内ドキュメント
- `外部調査` - 外部からの調査資料

## APIエンドポイント

### ナレッジ一覧取得

```
GET /api/knowledge
```

クエリパラメータ:
- `q` - 検索クエリ（タイトル・本文から検索）
- `business_unit_id` - 事業部門IDで絞り込み
- `tag` - タグで絞り込み

### ナレッジ作成

```
POST /api/knowledge
```

リクエストボディ:
```json
{
  "title": "ナレッジタイトル",
  "content": "ナレッジ本文（Markdown対応）",
  "business_unit_id": 1,
  "category": "レシピ",
  "source": "社内資料",
  "tags": ["タグ1", "タグ2"]
}
```

### ナレッジ更新

```
PUT /api/knowledge/{item_id}
```

### ナレッジ削除

```
DELETE /api/knowledge/{item_id}
```

※ 削除はadmin/headロールのみ可能

## スタッフQA AIとの連携

スタッフがAIチャットで質問すると、StaffQAServiceが以下の処理を行います：

1. 質問文から関連キーワードを抽出
2. ナレッジベースから関連情報を検索（最大3件）
3. 検索結果をコンテキストとしてAIに渡す
4. AIが回答を生成

### 検索の仕組み

現在はシンプルな全文検索（LIKE検索）を使用していますが、将来的には以下の拡張を予定しています：

- ベクトル検索（RAG）の導入
- 類義語対応
- 重み付けスコアリング

## 運用のベストプラクティス

### ナレッジの追加

1. **タイトルは具体的に**: 「レシピ」ではなく「クロックムッシュのレシピ」
2. **カテゴリを設定**: 検索性向上のため
3. **タグを活用**: 複数の観点からの検索を可能に
4. **事業部門を紐付け**: 権限管理とコンテキスト提供のため

### 定期的なメンテナンス

1. 古い情報の更新・削除
2. 重複ナレッジの統合
3. タグの正規化
4. 検索ログの分析（将来機能）

## トラブルシューティング

### シードスクリプトが失敗する

1. データベースに接続できることを確認
2. mikamoテナントが存在することを確認
3. 管理者ユーザーが存在することを確認

```bash
# データベース接続確認
cd backend
python -c "from app.core.database import engine; print('OK')"
```

### ナレッジが検索にヒットしない

1. ナレッジの`business_unit_id`とユーザーの所属を確認
2. staff/managerは自分の事業部門+全社共通のみ閲覧可能
3. 検索クエリが本文に含まれているか確認
