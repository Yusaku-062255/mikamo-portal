# みかもポータル v0.2 新機能ガイド

## 🎯 v0.2のミッション

「入力して終わり」のシステムから、**「AIが現場の参謀となり、データが経営の武器となり、コミュニケーションが組織を温める」**システムへと進化しました。

## 🤖 AI機能（現場の参謀化）

### 概要
OpenAI API (GPT-4o-mini) を使用した、ミカモ専属のエリアマネージャーとしてのAIアドバイザー機能です。

### 特徴
- **部署別コンテキスト**: 各部署（SOUP/M-NET/ミカモ石油/ミカモ喫茶/本部）の視点に合わせたアドバイス
- **直近データ連携**: 過去14日間の売上・客数・投稿内容を自動的にコンテキストに含める
- **今日の状況反映**: 今日の日報があれば、その内容も考慮したアドバイス
- **天気情報活用**: 天気と売上の相関を意識した提案

### 部署別の視点

#### SOUP（カーコーティング事業）
- 高単価コーティング・オプションの受注率向上
- 洗車からコーティングへのアップセル動線
- 施工品質と「納車体験」の向上

#### M-NET（中古車販売事業）
- 来店→商談→成約までのボトルネック発見
- 在庫回転率・粗利を意識した提案
- LINE / SNS などでのフォローアップ方法

#### ミカモ石油（ガソリンスタンド事業）
- 給油から洗車・コーティング・喫茶への送客動線
- ピーク時間帯の回転率アップと安全・事故防止
- 近隣住民の固定客化（声かけ・キャンペーン）

#### ミカモ喫茶（飲食・カフェ事業）
- 客単価アップ（セット・デザート・ドリンク提案）
- 滞在満足度と回転率のバランス
- SNS映え・口コミにつながる一言・工夫

#### 本部・経営
- 部署横断のトレンド・ボトルネック把握
- KPI設定・キャンペーン施策のアイデア

### 設定方法
`.env` ファイルに以下を追加：
```
OPENAI_API_KEY=your-openai-api-key
```

APIキーが設定されていない場合、フォールバック応答が返されます（システムは正常に動作します）。

## 📊 経営ダッシュボード（データの武器化）

### 売上・客数トレンドグラフ
- **対象**: マネージャー・headロール
- **期間**: 直近14日間
- **表示内容**: 
  - 売上金額（折れ線グラフ）
  - 客数（折れ線グラフ）
  - 天気情報（アイコン表示）

### 部署間比較グラフ
- **対象**: head/adminロールのみ
- **表示内容**: 全部署の今日の状況
  - 売上
  - 客数
  - 取引数

### 将来のKPI拡張への布石
v0.2では基本的な数値のみ表示していますが、将来的に以下のKPIを追加できる設計になっています：

- **SOUP**: コーティング案件比率
- **M-NET**: 商談→成約率
- **ミカモ石油**: 給油客の送客率
- **ミカモ喫茶**: 客単価（売上÷客数）

## 💬 エンゲージメント機能（組織の温度感）

### いいね機能
- 日報に「👍 いいね」をつけることができます
- `reaction_count` が自動的にカウントされます
- v0.2では単純なカウントアップ実装（v0.3以降で「誰が押したか」まで拡張予定）

### マネージャーコメント
- **対象**: マネージャー以上（manager, admin, head, accounting）
- **方針**: 「評価」ではなく「承認＋次の一歩のヒント」を重視
- **例**:
  - ❌ NG: 「ミスが多い。気をつけて。」
  - ✅ OK: 「◯◯の工夫が良かった。次は△△も試してみよう。」

### UI
- 一般スタッフ: コメントは読み取り専用で表示
- マネージャー: コメント編集欄が表示され、保存可能

## 📝 ロギング・エラーハンドリング

### バックエンド
- **JSON形式ログ**: Cloud Loggingでフィルタしやすい形式
- **リクエストID**: 各リクエストに一意のIDを付与し、ログを追跡可能に
- **エラーハンドリング**: 
  - 未捕捉例外を一元的に処理
  - クライアントには一般化されたエラーレスポンス
  - ログには詳細（request_id, パス, stack trace）を記録

### フロントエンド
- **Error Boundary**: 予期せぬエラー時に画面全体が真っ白になるのを防止
- **優しいエラーメッセージ**: 「エラーが発生しました。ページを再読み込みしてください。」

## 🌤️ 天気情報

### 現状（v0.2）
- スタッフまたはマネージャーが手動で入力（晴れ・曇り・雨・雪）
- AIへのコンテキストに含まれる
- グラフにアイコン表示

### 将来の拡張
- 外部天気API（OpenWeatherMap等）との連携
- 天気と売上の相関分析
- コード上に拡張ポイントを残しています

## 🚀 4事業それぞれにとってのDX価値

### SOUP（カーコーティング事業）
- AIが洗車からコーティングへのアップセル方法を提案
- 売上トレンドで受注率の改善を可視化

### M-NET（中古車販売事業）
- AIが来店から成約までのボトルネックを発見
- 部署間比較で在庫回転率を意識

### ミカモ石油（ガソリンスタンド事業）
- AIが給油客の送客動線を提案
- 天気と売上の相関を可視化

### ミカモ喫茶（飲食・カフェ事業）
- AIが客単価アップの方法を提案
- 滞在満足度と回転率のバランスを意識

### 本部・経営
- 全部署の状況を一覧で把握
- データに基づいた意思決定が可能
- AIが部署横断のトレンドを提案

## 📚 技術的な実装詳細

### リポジトリ層の追加
- `app/repositories/daily_log_repository.py`: データ取得ロジックを集約
- AIサービスやダッシュボードで再利用可能な設計

### AIサービスの実装
- `app/services/ai_service.py`: OpenAI API統合
- 部署別System Prompt、コンテキスト組み立てロジック

### グラフコンポーネント
- `frontend/src/components/charts/`: 再利用可能なグラフコンポーネント
- Rechartsを使用したレスポンシブ対応

## 🔧 設定・環境変数

### バックエンド
```bash
# OpenAI API（必須ではない、フォールバックあり）
OPENAI_API_KEY=your-api-key
OPENAI_MODEL=gpt-4o-mini
```

### フロントエンド
変更なし（既存の設定を継続使用）

## 📈 パフォーマンス

- AI回答生成: 通常2-5秒程度（OpenAI APIの応答時間に依存）
- グラフデータ取得: キャッシュなし、リアルタイム取得
- ログ出力: 非同期処理でパフォーマンスへの影響を最小化

## 🐛 トラブルシューティング

### AI機能が動作しない
- `OPENAI_API_KEY` が設定されているか確認
- 設定されていない場合、フォールバック応答が返されます（正常動作）

### グラフが表示されない
- マネージャー/headロールでログインしているか確認
- データが存在するか確認（直近14日間に投稿があるか）

### ログが出力されない
- `structlog` が正しくインストールされているか確認
- Cloud Loggingの設定を確認（本番環境）

